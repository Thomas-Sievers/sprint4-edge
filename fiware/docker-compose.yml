version: "3.8"

services:
  fiware-mongo:
    image: mongo:5.0
    container_name: fiware-mongo
    command: --nojournal
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - fiware

  fiware-orion:
    image: fiware/orion:3.11.0
    container_name: fiware-orion
    depends_on:
      - fiware-mongo
    ports:
      - "1026:1026"
    environment:
      - ORION_LOG_LEVEL=DEBUG
    command: -dbhost fiware-mongo -logLevel DEBUG
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1026/version"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fiware

  fiware-mosquitto:
    image: eclipse-mosquitto:2
    container_name: fiware-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    networks:
      - fiware
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf

  fiware-iot-agent:
    image: fiware/iotagent-ul:latest
    container_name: fiware-iot-agent
    depends_on:
      - fiware-orion
      - fiware-mongo
      - fiware-mosquitto
    ports:
      - "4041:4041"
    environment:
      - IOTA_CB_HOST=fiware-orion
      - IOTA_CB_PORT=1026
      - IOTA_NORTH_PORT=4041
      - IOTA_PROVIDER_URL=http://fiware-iot-agent:4041
      - IOTA_REGISTRY_TYPE=mongodb
      - IOTA_MONGO_HOST=fiware-mongo
      - IOTA_MONGO_PORT=27017
      - IOTA_LOG_LEVEL=DEBUG
      - IOTA_TIMESTAMP=true
      - IOTA_AUTOCAST=true
      - IOTA_CB_NGSI_VERSION=v2
      - IOTA_DEFAULT_RESOURCE=/TEF
      - IOTA_DEFAULT_APIKEY=tef_api_key
      - IOTA_CB_SERVICE=smart
      - IOTA_CB_SUBSERVICE=/
      - IOTA_HTTP_DISABLED=true
      - IOTA_AMQP_DISABLED=true
      - IOTA_MQTT_DISABLED=false
      - IOTA_MQTT_HOST=fiware-mosquitto
      - IOTA_MQTT_PORT=1883
      - IOTA_MQTT_USERNAME=
      - IOTA_MQTT_PASSWORD=
      - IOTA_MQTT_RETRIES=5
      - IOTA_MQTT_RETRY_TIME=5
      - IOTA_TRANSPORT=MQTT
    networks:
      - fiware
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4041/iot/about"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mongo_data:

networks:
  fiware:
    driver: bridge
